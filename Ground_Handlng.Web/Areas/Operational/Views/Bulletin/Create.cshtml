@model Ground_Handlng.DataObjects.Models.Operational.Bulletin.Bulletin
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{

}
<link rel="stylesheet" href="~/AdminLTE/dist/css/adminlte.min.css" />
<link rel="stylesheet" href="~/AdminLTE/plugins/bootstrap/css/bootstrap.min.css" />
<link rel="stylesheet" href="~/AdminLTE/plugins/datepicker/datepicker3.css" />

<style>
    input.error {
        border-color: #f00 !important;
    }

    small.required {
        color: #f00;
    }
</style>

<section class="content">
    <div class="card">
        <div class="card-body">
            @using (Html.BeginForm(FormMethod.Post, new { @class = "form-horizontal", @id = "validate", @enctype = "multipart/form-data", @role = "form" }))
            {
                @Html.AntiForgeryToken()

                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                <div class="callout callout-danger error-box-holder" id="general-error" style="display:none">
                    <h4> Please correct the following errors and sumbit again </h4>
                    <ul id="errors" class="error-box"></ul>
                </div>
                <div class="form-group">
                    <label asp-for="NoticeOrBulletin" class="control-label col-md-3"></label>
                    <div class="col-sm-7">
                        <select for="NoticeOrBulletin" class="form-control required" asp-items="@ViewBag.BulletinNoticeType" name="noticeorbulletin">
                            <option value=""></option>
                        </select>
                    </div>
                    <span for="NoticeOrBulletin" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="NoticeNumber" class="control-label col-md-3"></label>
                    <div class="col-sm-7">
                        <input for="NoticeNumber" class="form-control required" name="noticenumber" />
                    </div>
                    <span for="NoticeNumber" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="NoticeTo" class="control-label col-md-3"></label>
                    <div class="col-sm-7">
                        <select for="NoticeTo" class="form-control required" name="noticeto" asp-items="@ViewBag.BuilletinTo">
                            <option value=""></option>
                        </select>
                    </div>
                    <span for="NoticeTo" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Subject" class="control-label col-md-3"></label>
                    <div class="col-sm-7">
                        <input for="Subject" class="form-control required" name="subject" />
                    </div>
                    <span for="Subject" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Type" class="control-label col-md-3"></label>
                    <div class="col-sm-7">
                        <select for="Type" class="form-control required" name="type" asp-items="@ViewBag.BulletinType">
                            <option value=""></option>
                        </select>
                    </div>
                    <span for="Type" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="SentBy" class="control-label col-md-3"></label>
                    <div class="col-sm-7">
                        <select for="SentBy" class="form-control required" name="sentby" asp-items="@ViewBag.BulletinFrom">
                            <option value=""></option>
                        </select>
                    </div>
                    <span for="SentBy" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Remark" class="control-label col-md-3"></label>
                    <div class="col-sm-7">
                        <textarea for="Remark" class="form-control required" name="remark" rows="4"></textarea>
                    </div>
                    <span for="Remark" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="ExpirationDate" class="control-label col-md-3"></label>
                    <div class="col-sm-7">
                        <input for="ExpirationDate" class="form-control required date" name="expirationdate" />
                    </div>
                    <span for="ExpirationDate" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label for="city" class="control-label col-md-3">Section PDF</label>
                    <div class="col-md-7">
                        <input for="url" type="file" id="url" name="url" class="form-control" />
                    </div>
                    <span for="url" class="text-danger"></span>
                </div>
                <br />
                <div class="form-group col-md-3">
                    <button type="submit" class="btn btn-success btn-block"> Save </button>
                </div>
            }
        </div>
    </div>
</section>

<script src="~/AdminLTE/plugins/datepicker/bootstrap-datepicker.js"></script>
<script src="~/AdminLTE/plugins/jquery-validation/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
<script type="text/javascript">
    $(function () {
        $('.date').datepicker({
            format: 'yyyy-mm-dd'
        });
             $.validator.setDefaults({
                 submitHandler: function () {
                    $('#general-error').hide();
                     $('#errors').empty();
                     var formData = new FormData();
                     formData.append('url', $('#url')[0].files[0]);
                     var other_data = $('#validate').serializeArray();
                     $.each(other_data, function (key, input) {
                         formData.append(input.name, input.value);
                     });
                     $.ajax({
                         url: '/Operational/Bulletin/Create',
                         type: 'POST',
                         data: formData,
                         processData: false,
                         contentType: false,
                         cache: false,
                         success: function (data) {
                             debugger;
                             if (data.status == "3" || data.status == "4" || data.status == "5") {
                                 if (data.status == "3") {
                                     swal({
                                         type: 'success',
                                         title: data.message,
                                         showConfirmButton: false,
                                         timer: 3000
                                     }).then(() => { window.location = "/Operational/Bulletin/Index"; });;
                                     $('#modal').modal('hide');
                                 }
                                 else {
                                     swal({
                                         type: 'error',
                                         title: data.message,
                                         showConfirmButton: false,
                                         timer: 3000
                                     });
                                 }
                             }
                         },
                         error: function (datd) {
                             window.location = "/Operational/Bulletin/Index";
                             swal({
                                 type: 'error',
                                 title: data.message,
                                 showConfirmButton: false,
                                 timer: 3000
                             });

                         }

                     });
                }
            });
        $('#validate').validate({
            ignore: [],
            errorPlacement: function () { },
            invalidHandler: function () {
                setTimeout(function () {
                    $('.nav-tabs a small.required').remove();
                    var validatePane = $('.tab-content.tab-validate .tab-pane:has(input.error)').each(function () {
                        debugger;
                        var id = $(this).attr('id');
                        $('.nav-tabs').find('a[href^="#' + id + '"]').append('<small class="required">***</small>');
                    });
                });
            },
            rules: {
                noticeorbulletin: {
                    required: true
                },
                noticenumber: {
                    required: true
                },
                noticeto: {
                    required: true
                },
                subject: {
                    required: true
                },
                type: {
                    required: true
                },
                sentby: {
                    required: true
                },
                remark: {
                    required: true
                },
                expirationdate: {
                    required: true
                },
                url: {
                    required: true,
                    //fileMaxSize : true,
                    //extension: "docx|rtf|doc|pdf",
                },
            },
            messages: {
                noticeorbulletin: {
                    required: "Please enter a Notice Or Bulletin"
                },
                noticenumber: {
                    required: "Please provide a Notice Number",
                },
                noticeto: {
                    required: "Please enter a Notice To"
                },
                subject: {
                    required: "Please provide a Subject",
                },
                type: {
                    required: "Please enter a Type"
                },
                sentby: {
                    required: "Please provide a Sent By",
                },
                remark: {
                    required: "Please enter a Remark"
                },
                expirationdate: {
                    required: "Please provide a Expiry Date",
                },
                url: {
                    required: "Please provide a PDF",
                    //extension: "Please upload valid file formats"
                },
            },
            errorElement: 'span',
            errorPlacement: function (error, element) {
                error.addClass('invalid-feedback');
                element.closest('.form-group').append(error);
            },
            highlight: function (element, errorClass, validClass) {
                $(element).addClass('is-invalid');
            },
            unhighlight: function (element, errorClass, validClass) {
                $(element).removeClass('is-invalid');
            }

        });

        $("#url").on("change", function (e) {
            var filename = this.value;
            var files = this.files;
            var URL = window.URL || window.webkitURL;
            var url = URL.createObjectURL(files[0]);
            $(this).closest('.row').find('.preview').attr("href", url).show();
            $(this).next('.check').prop("disabled", true);
            var myfile = $(this).val();
            var ext = myfile.split('.').pop();
            if (ext == "pdf" ) {
                $(this).next('.check').val(filename);
            } else {
                $(this).closest('.row').find('.preview').hide()
                alert('Invalid File Type');
                $(this).next('.check').val('');
                e.preventDefault();
                $('#url').val('');
            }
            if (e.currentTarget.files[0].size >= 1024 * 1024 * 30) {//30000000
                alert('File Size cannot be more than 30 MB');
                e.preventDefault();
                $(this).closest('.row').find('.preview').hide();
                $('#url').val('');
            }
        });

    });
</script>