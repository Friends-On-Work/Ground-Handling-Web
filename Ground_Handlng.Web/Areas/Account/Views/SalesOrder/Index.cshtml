
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@model IEnumerable<Ground_Handlng.DataObjects.Models.Operational.SalesOrder>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_mainLayout.cshtml";
}

@**@
    <link href="~/AdminLTE/plugins/daterangepicker/daterangepicker-bs3.css" rel="stylesheet" />

    <link href="~/AdminLTE/plugins/datatables/dataTables.bootstrap4.css" rel="stylesheet" />
    <link href="~/AdminLTE/plugins/sweetalert/sweetalert2.min.css" rel="stylesheet" />


    @*<style type="text/css">
            #generalModal .modal-dialog {
                max-width: 65%;
            }

            #loader {
                color: #007bff;
                text-shadow: 1px 1px 1px #ccc;
            }

            #exportTemplateloader {
                color: #007bff;
                text-shadow: 1px 1px 1px #ccc;
            }
        </style>*@

    <style>

        /*.sending {
            display: none;
        }*/

        .modal {
            z-index: 1100;
        }

        #ticketingStatus .modal-dialog {
            width: 30%;
            max-width: 30%;
        }

        .modal .modal-dialog {
            width: 70%;
            max-width: 70%;
        }

        #loader {
            color: #2e7c31;
            text-shadow: 1px 1px 1px #ccc;
        }

        #loaderBill {
            /*color: #2e7c31;
            text-shadow: 1px 1px 1px #ccc;
            position: absolute;*/
            display: none;
            position: absolute;
            z-index: 100;
            margin-left: 43.5%;
            width: 8%;
            height: 12%;
            margin-top: 20%;
            color: #2e7c31;
            text-shadow: 1px 1px 1px #ccc;
        }

        #Modalloader {
            color: #007bff;
            text-shadow: 1px 1px 1px #ccc;
        }

        #tblHolder {
            min-height: 500px;
        }

        td.progress-col {
            position: relative;
        }

        span.progress-detail {
            position: absolute;
            width: 300%;
            display: table-cell;
            top: 0;
            background: wheat;
            display: none;
            z-index: 1000;
            padding: 5px 10px;
            border: solid #efefef;
        }

        td.progress-col:hover span.progress-detail {
            display: block;
        }

        #daterange-btn {
            color: #007bff;
        }

        #clear_btn {
            color: #007bff
        }

        #rangeSubmit {
            color: #007bff;
        }

        #voucherModal .modal-dialog {
            max-width: 70%;
        }

        #voucherModal .modal-content {
            height: 100%;
        }

        #voucherFrame {
            width: 100%;
            height: 500px;
        }
    </style>
@**@

<!-- Content Header (Page header) -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">

            <div class="col-sm-6">
                <h1>Sales Orders</h1>
            </div>

            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "SalesOrderDashboard", new { area = "SalesOrder"})"><i class="fa fa-home"></i> Home</a></li>
                    <li class="breadcrumb-item active"><i class="fa fa-unlock"></i> Sales Orders</li>
                </ol>
            </div>

        </div>
    </div><!-- /.container-fluid -->
</section>

<section class="content">
    <!-- Default box -->
    <div class="card">

        <div class="card-header">

            <div class="row">

                <h3 class="card-title ol-sm-2">
                    @*<a class="box-title createChartOfAccount" href="#"><i class="fa fa-plus text-primary"></i> New Payment </a>*@
                    @Html.ActionLink("New Payment", "Create")
                </h3>

                <div class="col-sm-2">
                    <a class="dropdown-item export" href="#">
                        <i class="fa fa-file-excel-o"></i> &nbsp;&nbsp;&nbsp;
                        Export
                    </a>
                </div>

                <div class="col-sm-8">
                    <form asp-area="Account" asp-controller="SalesOrder" asp-action="Index"
                          method="post" enctype="multipart/form-data" class="form-horizontal" id="IndexSearchByDateForm">

                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item active">
                                <div class="col-sm-10">
                                    <div class="input-group">
                                        <button type="button" class="btn btn-default" id="daterange-btn">
                                            <span>
                                                <i class="fa fa-calendar"></i>
                                                @if (ViewBag.dateRange != null)
                                                {
                                                    @ViewBag.dateRange
                                                }
                                                else
                                                {
                                                    <span> Date Picker </span>
                                                }
                                            </span>
                                            <i class="fa fa-caret-down"></i>
                                        </button>
                                        <input type="text" value="" style="display:none" id="dateRange" name="dateRange" />
                                    </div>
                                </div>
                            </li>
                        </ol>

                    </form>
                </div>
            </div>



        </div>
        <div class="card-body">


            <div class="box-body table-responsive no-padding">

                <table id="tblSaleOrders" class="table table-hover">
                    <thead>
                        <tr>
                            <th></th>
                            <th>
                                @Html.DisplayNameFor(model => model.FullName)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.OrderCode)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Amount)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Currency.Code)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.IsPaid)
                            </th>
                            <th>
                                @Html.DisplayNameFor(model => model.Email)
                            </th>
                            <th>Created Date </th>
                            <th>Created By </th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            if (Model != null && Model.Count() > 0)
                            {
                                int i = 1;
                                foreach (var item in Model)
                                {
                                    <tr>
                                        <td>@(i++)</td>
                                        <td>
                                            @Html.DisplayFor(modelItem => item.FullName)
                                        </td>
                                        <td>
                                            @Html.DisplayFor(modelItem => item.OrderCode)
                                        </td>
                                        <td>
                                            @Html.DisplayFor(modelItem => item.Amount)
                                        </td>
                                        <td>
                                            @Html.DisplayFor(modelItem => item.Currency.Code)
                                        </td>
                                        <td>
                                            @Html.DisplayFor(modelItem => item.IsPaid)
                                        </td>
                                        <td>
                                            @Html.DisplayFor(modelItem => item.Email)
                                        </td>
                                        <td>
                                            @item.CreationDate.ToString("dd/MM/yyyy")
                                        </td>
                                        <td>
                                            @Html.DisplayFor(modelItem => item.CreatedBy)
                                        </td>
                                        <td>
                                            @{
                                                if (item.IsPaid)
                                                {
                                                    @Html.Raw("Paid");
                                                }
                                                else if (!string.IsNullOrEmpty(item.PaymentUri))
                                                {
                                                    @Html.Raw("Ready to Pay");
                                                }
                                                else
                                                {
                                                    @Html.Raw("Ready to Create Order Code");
                                                }
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-info">Actions</button>
                                                <button type="button" class="btn btn-info btn-flat dropdown-toggle" data-toggle="dropdown">
                                                    @*<i class="fa fa-gear text-primary" data-toggle="dropdown" title="Settings"></i>*@
                                                    <span class="sr-only">Sales Order Dropdown Actions</span>
                                                </button>

                                                <div class="dropdown-menu" role="menu">
                                                    @{
                                                        if (!item.IsPaid)
                                                        {
                                                            <a class="dropdown-item editSalesOrder" href="#" data-id="@item.Id">Edit </a>
                                                        }

                                                        if (!item.IsPaid && string.IsNullOrEmpty(item.PaymentUri))
                                                        {
                                                            <a class="dropdown-item createOrder" href="#" data-id="@item.Id">Create Order </a>
                                                        }

                                                        if (!item.IsPaid && !string.IsNullOrEmpty(item.PaymentUri))
                                                        {
                                                            <a class="dropdown-item makePayment" href="#" data-id="@item.PaymentUri">Make Payment </a>
                                                        }

                                                        if (item.IsPaid)
                                                        {
                                                            <a class="dropdown-item issueBill" href="#" data-id="@item.Id">Issue Bill </a>
                                                        }

                                                        if (!item.IsPaid)
                                                        {
                                                            <a class="dropdown-item deleteSalesOrder" href="#" data-id="@item.Id">Delete</a>
                                                        }
                                                    }
                                                </div>
                                            </div>
                                            @*@Html.ActionLink("Edit", "Edit", new { id = item.Id }) |
                                                @Html.ActionLink("Details", "Details", new { id = item.Id }) |
                                                @Html.ActionLink("Delete", "Delete", new { id = item.Id })*@
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                </table>

            </div>

        </div>

    </div>

    <div id="generalModal" class="modal fade">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modalHeader"></h4>
                    <button type="button" class="close" id="editModalPopup" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body" id="modalBody">

                </div>
                <div class="overlay" id="loader">
                    <i class="fa fa-refresh fa-spin fa-3x offset-sm-5"></i>
                    <br /><br /><br />
                </div>
            </div>
        </div>
    </div>

    <div id="voucherModal" class="modal fade" style="display:none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="col-sm-4 offset-sm-4"> <h3 class="text-center" id="Vheader"> Bill </h3>  </div>
                </div>
                <div class="modal-body" id="voucherBody">
                    <div class="overlay" id="loaderBill">
                        <i class="fa fa-refresh fa-spin fa-3x offset-sm-5"></i>
                        <br /><br /><br />
                    </div>
                    <div class="modal-body" id="modalBody"></div>
                    <div class="col-sm-10 offset-sm-1">
                        <iframe id="voucherFrame"> </iframe>
                    </div>
                </div>
                <div class="modal-footer">
                    @*<div class="col-sm-4"> </div>
                        <div class="col-sm-4"> <button class="sending btn col-sm-6 offset-sm-3" style="background:#007bff;color:white" id="Sending" onclick="SendVoucher()"> Print </button> </div>
                        <div class="col-sm-4"> </div>*@
                </div>
            </div>
        </div>
    </div>


</section>


@**@
    <script src="~/AdminLTE/plugins/datatables/jquery.dataTables.js"></script>
    <script src="~/AdminLTE/plugins/datatables/dataTables.bootstrap4.js"></script>
    <script src="~/AdminLTE/plugins/sweetalert/sweetalert2.min.js"></script>

    <script src="~/AdminLTE/plugins/daterangepicker/moment.js"></script>
    <script src="~/AdminLTE/plugins/daterangepicker/daterangepicker.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {

            @if (ViewBag.SuccessAlertMessage != null)
            {
                <text>
                    swal({
                        position: 'center',
                        type: 'success',
                        title: '@ViewBag.SuccessAlertMessage',//'Your work has been saved',
                        showConfirmButton: false,
                        timer: 3000
                    });
                </text>
                 ViewBag.SuccessAlertMessage = null;
            }

            @if (ViewBag.FailureAlertMessage != null)
            {
                <text>
                    swal({
                        position: 'center',
                        type: 'error',
                        title: '@ViewBag.FailureAlertMessage',//'Your work has been saved',
                        showConfirmButton: false,
                        timer: 3000
                    })
                </text>
                 ViewBag.FailureAlertMessage = null;
            }

            $("#dateRange").val('@ViewBag.DateRange');
            $('#daterange-btn span').html('@ViewBag.DateRangeText');

            var salesOrder = $('#tblSaleOrders').DataTable({
                "paging": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "autoWidth": false,
                "iDisplayLength": 25,
            });

            $('body').on('click', ".makePayment", function () {

                var uri = $(this).attr("data-id");
                //alert('makePayment clicked =' + uri);

                if (uri != null) {
                    //window.location.href = uri;
                    window.open(uri, '_blank');
                }
                else {
                    swal({
                        position: 'center',
                        type: 'error',
                        title: 'Invalid payment URL. Please try again',
                        showConfirmButton: false,
                        timer: 3000
                    });
                }
            });

            $('body').on('click', ".editSalesOrder", function () {

                var id = $(this).attr("data-id");
                $('#modalHeader').html('Edit Sales Order');

                var url = "/Account/SalesOrder/Edit";
                url = url + '?id=' + id;

                $("#modalBody").empty();
                $("#loader").show();
                $("#generalModal").modal('show');

                $.get(url, function (data) {

                    $("#modalBody").empty();
                    $("#modalBody").html(data);

                    $("#loader").hide();
                });
            });

            $('body').on('click', ".deleteSalesOrder", function () {

                var id = $(this).attr("data-id");
                $('#modalHeader').html('Delete Sales Order');

                var url = "/Account/SalesOrder/Delete";
                url = url + '?id=' + id;

                $("#modalBody").empty();
                $("#loader").show();
                $("#generalModal").modal('show');

                $.get(url, function (data) {

                    $("#modalBody").empty();
                    $("#modalBody").html(data);

                    $("#loader").hide();
                });
            });

            $('body').on('click', ".createOrder", function () {

                var id = $(this).attr("data-id");
                $('#modalHeader').html('Creating Payment Order');

                var url = "/Account/SalesOrder/CreatePaymenOrder";
                url = url + '?id=' + id;

                $("#modalBody").empty();
                $("#loader").show();
                $("#generalModal").modal('show');

                var data = { Id : id };

                $.post(url, data, function (data) {
                    window.location.href = "/Account/SalesOrder/Index?Message=" + data.data.message + "&IsSuccess=" + data.data.isSuccess;
                });
            });

            $('body').on('click', ".export", function () {

                var url = "/Account/SalesOrder/Export";

                var data = { Id: 0 };

                $.post(url, data, function (data) {
                    window.location.href = "/Account/SalesOrder/Download?fileName=" + data;
                });
            });

            $('body').on('click', ".issueBill", function () {

                $("#Vheader").empty();
                var iframe = document.getElementById("voucherFrame");
                iframe.contentWindow.document.open();
                iframe.contentWindow.document.close();

                $("#voucherFrame").empty();
                $("#Vheader").html("Bill");

                var id = $(this).attr('data-id');

                var url = "/Account/SalesOrder/HotelPaymentBill";
                url = url + '?id=' + id;

                if (iframe.url)
                    iframe.url = url;
                else if (iframe.contentWindow !== null && iframe.contentWindow.location !== null)
                    iframe.contentWindow.location = url;
                else
                    iframe.setAttribute("src", url);

                $("#voucherModal").modal('show');
                $("#loaderBill").show();
             });

            $("#voucherFrame").on("load", function () {
                $("#loaderBill").hide();
            });

            $('#daterange-btn').daterangepicker(
                {
                    ranges: {
                        'Today': [moment(), moment()],
                        'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                        'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                        'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                        'This Month': [moment().startOf('month'), moment().endOf('month')],
                        'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                    },
                    startDate: moment().subtract(6, 'days'),
                    endDate: moment()
                },
                function (start, end) {
                    $('#daterange-btn span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                    $("#dateRange").val(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                    $('#IndexSearchByDateForm').submit();
                }
            );
        });
    </script>
@**@
